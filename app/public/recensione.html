// =========================================================
// RECENSIONE â€” stelle + commento + tracking
// =========================================================

document.addEventListener("DOMContentLoaded", () => {

  const params = new URLSearchParams(location.search);
  const product = params.get("product") || "Prodotto acquistato";

  document.getElementById("productName").textContent =
    "Stai recensendo: " + product;

  const stars = document.querySelectorAll("#stars span");
  const comment = document.getElementById("comment");
  const status = document.getElementById("status");
  let rating = 0;

  // â­ Selezione stelle
  stars.forEach(star => {
    star.addEventListener("click", () => {
      rating = Number(star.dataset.v);

      stars.forEach(s => s.classList.remove("active"));
      for (let i = 0; i < rating; i++) {
        stars[i].classList.add("active");
      }
    });
  });

  // ðŸ“© Invio recensione
  document.getElementById("sendReview").addEventListener("click", async () => {
    status.style.color = "#d00";

    if (rating === 0) {
      status.textContent = "Seleziona un numero di stelle.";
      return;
    }

    if (comment.value.trim().length < 5) {
      status.textContent = "Scrivi un commento piÃ¹ dettagliato.";
      return;
    }

    // Tracking frontend
    if (window.trackEvent) {
      trackEvent("review_submitted", {
        product,
        rating,
        comment: comment.value.trim()
      });
    }

    // Backend-ready (ma non obbligatorio ora)
    try {
      await fetch("/api/reviews/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          product,
          rating,
          comment: comment.value.trim(),
          date: new Date().toISOString()
        })
      });
    } catch (err) {
      console.warn("Backend non ancora configurato, recensione salvata solo lato tracking.");
    }

    status.style.color = "green";
    status.textContent = "Grazie! La tua recensione Ã¨ stata inviata.";

    comment.value = "";
  });
});
