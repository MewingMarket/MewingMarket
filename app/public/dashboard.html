<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- HEAD DINAMICO (blindato) -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("head.html")
        .then(r => r.text())
        .then(html => {
          const temp = document.createElement("div");
          temp.innerHTML = html;
          [...temp.children].forEach(node => document.head.appendChild(node));
        })
        .catch(err => console.error("Errore caricamento head:", err));
    });
  </script>

  <title>Dashboard Vendite – MewingMarket</title>
  <link rel="stylesheet" href="/style.css">
</head>

<body>

<div class="dashboard-header">
  Dashboard Vendite – MewingMarket
  <button style="float:right;background:#fff;color:#000;padding:6px 12px;border-radius:6px;border:none;cursor:pointer;margin-left:10px;"
          onclick="location.href='/tracking.html'">Tracking</button>
  <button style="float:right;background:#fff;color:#000;padding:6px 12px;border-radius:6px;border:none;cursor:pointer;"
          onclick="location.reload()">Aggiorna</button>
</div>

<div class="dashboard-container">

  <h2>Performance Prodotti</h2>
  <table class="dashboard-table" id="productsTable">
    <thead>
      <tr>
        <th>Prodotto</th>
        <th>Vendite</th>
        <th>Categoria</th>
        <th>Video</th>
        <th>Descrizione</th>
        <th>Qualità</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Tutte le Vendite</h2>
  <table class="dashboard-table" id="salesTable">
    <thead>
      <tr>
        <th>Prodotto</th>
        <th>Prezzo</th>
        <th>Origine</th>
        <th>UTM</th>
        <th>Referrer</th>
        <th>Device</th>
        <th>Lingua</th>
        <th>Data</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<script>
/* =========================================================
   SANITIZZAZIONE
========================================================= */
const clean = (t) =>
  typeof t === "string"
    ? t.replace(/</g, "&lt;").replace(/>/g, "&gt;").trim()
    : "";

/* =========================================================
   SECRET (blindato)
========================================================= */
const secret = clean(new URLSearchParams(location.search).get("secret") || "");

/* =========================================================
   FETCH BLINDATI
========================================================= */
async function loadSales() {
  try {
    const res = await fetch(`/api/sales?secret=${secret}`);
    if (!res.ok) throw new Error("Errore fetch vendite");
    return await res.json();
  } catch (err) {
    console.error(err);
    return [];
  }
}

async function loadSummary() {
  try {
    const res = await fetch(`/api/sales/summary?secret=${secret}`);
    if (!res.ok) throw new Error("Errore fetch summary");
    return await res.json();
  } catch (err) {
    console.error(err);
    return {};
  }
}

/* =========================================================
   RENDER PRODOTTI (blindato)
========================================================= */
function renderProducts(summary) {
  const tbody = document.querySelector("#productsTable tbody");
  tbody.innerHTML = "";

  Object.values(summary || {}).forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${clean(p.titolo)}</td>
      <td>${clean(String(p.vendite))}</td>
      <td>${clean(p.categoria)}</td>
      <td>${p.video ? "✔" : "—"}</td>
      <td>${p.descrizioneBreve ? "✔" : "—"}</td>
      <td class="score ${clean(p.score)}">${clean(p.score).toUpperCase()}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* =========================================================
   RENDER VENDITE (blindato)
========================================================= */
function renderSales(sales) {
  const tbody = document.querySelector("#salesTable tbody");
  tbody.innerHTML = "";

  (sales || []).forEach(s => {
    const f = s.fields || {};
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${clean(f.Prodotto)}</td>
      <td>${clean(String(f.Prezzo))}</td>
      <td>${clean(f.Origine)}</td>
      <td>${clean(f.UTMSource || "")}</td>
      <td>${clean(f.Referrer || "")}</td>
      <td>${clean(f.Device || "")}</td>
      <td>${clean(f.Lingua || "")}</td>
      <td>${clean(f.Timestamp)}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* =========================================================
   INIT (blindato)
========================================================= */
(async () => {
  const sales = await loadSales();
  const summary = await loadSummary();

  renderSales(sales);
  renderProducts(summary);
})();
</script>

</body>
</html>
