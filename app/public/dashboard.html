<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Vendite – MewingMarket</title>
<link rel="stylesheet" href="/style.css">
</head>

<body>

<div class="dashboard-header">
  Dashboard Vendite – MewingMarket
  <button style="float:right;background:#fff;color:#000;padding:6px 12px;border-radius:6px;border:none;cursor:pointer;margin-left:10px;"
          onclick="location.href='/tracking.html'">Tracking</button>
  <button style="float:right;background:#fff;color:#000;padding:6px 12px;border-radius:6px;border:none;cursor:pointer;"
          onclick="location.reload()">Aggiorna</button>
</div>

<div class="dashboard-container">

  <h2>Performance Prodotti</h2>
  <table class="dashboard-table" id="productsTable">
    <thead>
      <tr>
        <th>Prodotto</th>
        <th>Vendite</th>
        <th>Categoria</th>
        <th>Video</th>
        <th>Descrizione</th>
        <th>Qualità</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Tutte le Vendite</h2>
  <table class="dashboard-table" id="salesTable">
    <thead>
      <tr>
        <th>Prodotto</th>
        <th>Prezzo</th>
        <th>Origine</th>
        <th>UTM</th>
        <th>Referrer</th>
        <th>Device</th>
        <th>Lingua</th>
        <th>Data</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<script>
const secret = new URLSearchParams(location.search).get("secret");

async function loadSales() {
  const res = await fetch(`/api/sales?secret=${secret}`);
  return await res.json();
}

async function loadSummary() {
  const res = await fetch(`/api/sales/summary?secret=${secret}`);
  return await res.json();
}

function renderProducts(summary) {
  const tbody = document.querySelector("#productsTable tbody");
  tbody.innerHTML = "";

  Object.values(summary).forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.titolo}</td>
      <td>${p.vendite}</td>
      <td>${p.categoria}</td>
      <td>${p.video ? "✔" : "—"}</td>
      <td>${p.descrizioneBreve ? "✔" : "—"}</td>
      <td class="score ${p.score}">${p.score.toUpperCase()}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderSales(sales) {
  const tbody = document.querySelector("#salesTable tbody");
  tbody.innerHTML = "";

  sales.forEach(s => {
    const f = s.fields;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${f.Prodotto}</td>
      <td>${f.Prezzo}</td>
      <td>${f.Origine}</td>
      <td>${f.UTMSource || ""}</td>
      <td>${f.Referrer || ""}</td>
      <td>${f.Device || ""}</td>
      <td>${f.Lingua || ""}</td>
      <td>${f.Timestamp}</td>
    `;
    tbody.appendChild(tr);
  });
}

(async () => {
  const sales = await loadSales();
  const summary = await loadSummary();

  renderSales(sales);
  renderProducts(summary);
})();
</script>

</body>
</html>
